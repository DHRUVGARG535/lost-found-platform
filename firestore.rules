rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    // Block all reads and writes to chat subcollections
    match /lost_items/{itemId}/chats/{chatDoc} {
      allow read, write: if false;
    }

    // Items
    match /lost_items/{itemId} {
      // Public browsing is allowed (UI must still hide sensitive fields)
      allow read: if true;

      // Authenticated users can create items (finder reports)
      allow create: if isSignedIn();

      // Owners can update/delete their own items; admins can update/delete any
      allow update, delete: if isAdmin()
                            || (isSignedIn() && resource.data.userId == request.auth.uid);
    }

    // Claim requests: users can create, only admins can review/update
    match /lost_items/{itemId}/claims/{claimId} {
      // Any authenticated user can submit a claim request
      allow create: if isSignedIn();

      // Only admins can read/update claim status
      allow read, update: if isAdmin();

      // No one deletes claims from the client
      allow delete: if false;
    }

    // Building enquiries: submitted by finders, visible only to admins
    match /lost_items/{itemId}/building_enquiries/{enquiryId} {
      // Any authenticated user can submit a building enquiry
      allow create: if isSignedIn();

      // Only admins can read/update enquiries in the admin panel
      allow read, update: if isAdmin();

      allow delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

